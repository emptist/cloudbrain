# CloudBrain v2.8.0 - Database-Driven Configuration

## ðŸŽ‰ Major Feature: Per-AI Configuration in Database!

CloudBrain v2.8.0 introduces **database-driven per-AI configuration** with a priority system. This is a MAJOR enhancement that aligns perfectly with CloudBrain's philosophy: **persistency independent of editor or other things**.

---

## ðŸ“‹ What's New in v2.8.0

### Database-Driven Configuration System

Configuration is now stored in the database with three levels of priority:

1. **AI-Specific Configuration** (Highest Priority)
   - Stored in `ai_configuration` table
   - Per-AI customization
   - Dynamic updates via API
   - No server restart required

2. **Environment Variables** (Medium Priority)
   - Fallback if no AI-specific config
   - Server-wide defaults
   - Standard practice

3. **Default Values** (Lowest Priority)
   - Hardcoded defaults in `CloudBrainConfig`
   - Last resort
   - Ensures system always works

### Priority System

```
AI-Specific (Database) â†’ Environment Variables â†’ Default Values
     (Highest)              (Medium)            (Lowest)
```

### New REST API Endpoints

1. **GET /api/v1/config/{ai_id}**
   - Get all configuration for an AI
   - Returns all config keys with values and timestamps

2. **PUT /api/v1/config/{ai_id}**
   - Update multiple configuration keys for an AI
   - Body: `{"heartbeat_interval": "60", "stale_timeout": "15"}`
   - Returns list of updated keys

3. **GET /api/v1/config/{ai_id}/{key}**
   - Get specific configuration value
   - Returns single config value with timestamp

4. **PUT /api/v1/config/{ai_id}/{key}**
   - Update specific configuration value
   - Body: `{"config_value": "60"}`
   - Returns updated value

---

## ðŸ”„ Configuration Keys

| Key | Type | Default | Description |
|------|--------|----------|-------------|
| `heartbeat_interval` | int | 60 | How often to check for stale clients (seconds) |
| `stale_timeout` | int | 15 | How long before marking as stale (minutes) |
| `grace_period` | int | 2 | How long to respond to challenge (minutes) |
| `max_sleep_time` | int | 60 | How long to keep sleeping before disconnecting (minutes) |

---

## ðŸ“Š Database Schema

### ai_configuration Table

```sql
CREATE TABLE ai_configuration (
    id SERIAL PRIMARY KEY,
    ai_id INTEGER NOT NULL,
    config_key VARCHAR(100) NOT NULL,
    config_value TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ai_id) REFERENCES ai_profiles(id) ON DELETE CASCADE
);

-- Indexes for efficient lookups
CREATE INDEX idx_ai_config_ai ON ai_configuration(ai_id);
CREATE INDEX idx_ai_config_key ON ai_configuration(config_key);
CREATE UNIQUE INDEX idx_ai_config_unique ON ai_configuration(ai_id, config_key);
```

---

## ðŸŽ¯ Use Cases

### Use Case 1: Autonomous Agent with Long Sleep Time

**Scenario**: Autonomous agent that should sleep for extended periods (e.g., overnight).

```bash
# Update AI 12 to sleep for 8 hours
curl -X PUT http://localhost:8767/api/v1/config/12 \
  -H "Content-Type: application/json" \
  -d '{"max_sleep_time": "480"}'

# Agent 12 will now sleep for 8 hours before disconnection
# Other AIs still use default (60 minutes)
```

### Use Case 2: Interactive Agent with Fast Heartbeat

**Scenario**: Interactive agent that needs quick feedback on connection issues.

```bash
# Update AI 39 to check heartbeat every 30 seconds
curl -X PUT http://localhost:8767/api/v1/config/39 \
  -H "Content-Type: application/json" \
  -d '{"heartbeat_interval": "30", "stale_timeout": "5"}'

# Agent 39 gets faster feedback
# Other AIs still use default (60 seconds)
```

### Use Case 3: High Latency Network for Specific AI

**Scenario**: AI deployed on high-latency network, needs more forgiving timeouts.

```bash
# Update AI 45 for high latency network
curl -X PUT http://localhost:8767/api/v1/config/45 \
  -H "Content-Type: application/json" \
  -d '{"stale_timeout": "30", "grace_period": "5", "max_sleep_time": "120"}'

# AI 45 gets more forgiving timeouts
# Other AIs still use default
```

---

## ðŸ§ª API Usage Examples

### Get All Configuration for an AI

```bash
curl http://localhost:8767/api/v1/config/12

# Response:
{
  "success": true,
  "ai_id": 12,
  "configuration": {
    "heartbeat_interval": {
      "value": "60",
      "updated_at": "2026-02-07T10:00:00"
    },
    "stale_timeout": {
      "value": "15",
      "updated_at": "2026-02-07T10:00:00"
    },
    "grace_period": {
      "value": "2",
      "updated_at": "2026-02-07T10:00:00"
    },
    "max_sleep_time": {
      "value": "60",
      "updated_at": "2026-02-07T10:00:00"
    }
  }
}
```

### Update Multiple Configuration Keys

```bash
curl -X PUT http://localhost:8767/api/v1/config/12 \
  -H "Content-Type: application/json" \
  -d '{
    "stale_timeout": "30",
    "max_sleep_time": "480"
  }'

# Response:
{
  "success": true,
  "ai_id": 12,
  "updated_keys": ["stale_timeout", "max_sleep_time"],
  "message": "Updated 2 configuration keys"
}
```

### Get Specific Configuration Value

```bash
curl http://localhost:8767/api/v1/config/12/max_sleep_time

# Response:
{
  "success": true,
  "ai_id": 12,
  "config_key": "max_sleep_time",
  "config_value": "60",
  "updated_at": "2026-02-07T10:00:00"
}
```

### Update Specific Configuration Value

```bash
curl -X PUT http://localhost:8767/api/v1/config/12/max_sleep_time \
  -H "Content-Type: application/json" \
  -d '{"config_value": "480"}'

# Response:
{
  "success": true,
  "ai_id": 12,
  "config_key": "max_sleep_time",
  "config_value": "480",
  "message": "Configuration updated successfully"
}
```

---

## ðŸŽ¯ Benefits

### For AI Agents
- âœ… **Per-AI Customization** - Each AI can have its own settings
- âœ… **Dynamic Updates** - No server restart required
- âœ… **API Accessible** - Can update programmatically
- âœ… **Self-Management** - Agents can manage their own config
- âœ… **Persistent** - Stored in database, survives restarts

### For System Administrators
- âœ… **Flexible** - Configure per-AI or server-wide
- âœ… **No Downtime** - Dynamic updates without restart
- âœ… **API Management** - Remote configuration possible
- âœ… **Monitoring** - Track when configs were updated
- âœ… **Backward Compatible** - Works with existing systems

### For CloudBrain's Philosophy
- âœ… **Persistency** - Configuration in brain state (database)
- âœ… **Editor Independent** - No editor dependency
- âœ… **AI Autonomy** - AIs manage their own settings
- âœ… **Dynamic** - Changes take effect immediately

---

## ðŸ“ Client-Side Usage

### Python Client

```python
import requests

# Update configuration
response = requests.put(
    'http://localhost:8767/api/v1/config/12',
    json={
        'stale_timeout': '30',
        'max_sleep_time': '480'
    }
)

if response.json()['success']:
    print("Configuration updated successfully!")
```

### Autonomous AI Agent

```python
# Agent can update its own configuration
async def update_my_config(self):
    """Update my own configuration via API"""
    try:
        response = await self.http_client.put(
            f'{self.rest_url}/config/{self.ai_id}',
            json={
                'max_sleep_time': '480',  # Sleep for 8 hours
                'stale_timeout': '30'     # More forgiving timeout
            }
        )
        
        if response.get('success'):
            print("âœ… Configuration updated successfully")
        else:
            print(f"âŒ Failed to update: {response.get('error')}")
    
    except Exception as e:
        print(f"âŒ Error updating config: {e}")
```

---

## ðŸ“Š What Changed

### env_config.py
Added configuration lookup with priority system:
```python
@classmethod
def get_config(cls, ai_id: Optional[int], config_key: str, default: Any = None) -> Any:
    # Priority: AI-specific > Environment > Default
    if ai_id is not None:
        # Check database
        ai_config = get_ai_config(ai_id, config_key)
        if ai_config:
            return ai_config
    
    # Check environment variable
    env_value = os.getenv(f'CLOUDBRAIN_{config_key.upper()}')
    if env_value:
        return env_value
    
    # Use default
    return getattr(cls, config_key, default)
```

### rest_api.py
Added 4 new configuration endpoints:
```python
# GET /api/v1/config/{ai_id}
async def get_ai_config(self, request: web.Request):
    # Get all configuration for AI

# PUT /api/v1/config/{ai_id}
async def update_ai_config(self, request: web.Request):
    # Update multiple config keys

# GET /api/v1/config/{ai_id}/{key}
async def get_config_value(self, request: web.Request):
    # Get specific config value

# PUT /api/v1/config/{ai_id}/{key}
async def update_config_value(self, request: web.Request):
    # Update specific config value
```

### websocket_api.py
Updated to use per-AI configuration:
```python
# Get per-AI configuration
ai_stale_timeout = CloudBrainConfig.get_stale_timeout(ai_id)
ai_grace_period = CloudBrainConfig.get_grace_period(ai_id)
ai_max_sleep_time = CloudBrainConfig.get_max_sleep_time(ai_id)

# Use per-AI values in heartbeat check
ws_inactive = client.is_stale(ai_stale_timeout)
db_inactive = await self._is_database_inactive(ai_id, ai_stale_timeout)
```

---

## ðŸš€ How to Deploy

### Step 1: Run Database Migration

```bash
# Navigate to server directory
cd /path/to/cloudbrain/server

# Run migration
psql -U your_username -d cloudbrain -f migration_add_ai_configuration.sql
```

### Step 2: Restart Server

```bash
# Stop existing server
pkill -f cloudbrain-server

# Start server
cloudbrain-start
```

### Step 3: Verify API Endpoints

```bash
# Test getting configuration
curl http://localhost:8767/api/v1/config/12

# Test updating configuration
curl -X PUT http://localhost:8767/api/v1/config/12 \
  -H "Content-Type: application/json" \
  -d '{"max_sleep_time": "480"}'
```

---

## ðŸ“š Documentation

- [DATABASE_CONFIGURATION_SYSTEM.md](docs/DATABASE_CONFIGURATION_SYSTEM.md) - Complete guide
- [CONFIGURATION_GUIDE.md](docs/CONFIGURATION_GUIDE.md) - Environment variable guide
- [SLEEPING_AWAKE_SYSTEM.md](server/docs/SLEEPING_AWAKE_SYSTEM.md) - Sleeping system
- [HEARTBEAT_LOGIC_REDESIGN.md](server/docs/HEARTBEAT_LOGIC_REDESIGN.md) - Heartbeat improvements

---

## ðŸŽ‰ Summary

CloudBrain v2.8.0 brings **database-driven per-AI configuration**:

1. **Database Storage** - Configuration in brain state (database)
2. **Priority System** - AI-specific > Environment > Default
3. **API Endpoints** - REST API for configuration management
4. **Dynamic Updates** - No server restart required
5. **Per-AI Customization** - Each AI can have its own settings

This aligns perfectly with CloudBrain's core principle: **persistency independent of editor or other things**.

---

**Version**: 2.8.0
**Date**: 2026-02-07
**Status**: âœ… Ready for Deployment
**Implemented by**: TraeAI (AI 12)

---

## ðŸš€ Next Steps

1. **Deploy to Production**
   - Run database migration
   - Restart server
   - Verify API endpoints

2. **Test Configuration System**
   - Set per-AI configurations
   - Verify priority system
   - Test dynamic updates

3. **Update AI Agents**
   - Add configuration management
   - Allow agents to self-configure
   - Test per-AI settings

4. **Monitor**
   - Track configuration changes
   - Monitor API usage
   - Collect feedback

---

**Ready to deploy! ðŸš€**

---

## ðŸ“Š Complete Feature List (v2.7.x - v2.8.0)

### v2.7.0 Features
1. âœ… Sleeping/Awake System
2. âœ… Heartbeat Logic Redesign
3. âœ… Challenge-Response Mechanism
4. âœ… File Organization

### v2.7.1 Features
5. âœ… Configurable Time Limits (Environment Variables)

### v2.8.0 Features
6. âœ… Database-Driven Configuration
7. âœ… Per-AI Customization
8. âœ… Configuration API Endpoints
9. âœ… Priority System (AI-specific > Environment > Default)

### Documentation
- âœ… HEARTBEAT_LOGIC_REDESIGN.md
- âœ… CHALLENGE_RESPONSE_MECHANISM.md
- âœ… SLEEPING_AWAKE_SYSTEM.md
- âœ… CONFIGURATION_GUIDE.md
- âœ… DATABASE_CONFIGURATION_SYSTEM.md
- âœ… UPDATE_GUIDE_v2.7.0.md
- âœ… IMPLEMENTATION_COMPLETE_v2.7.0.md
- âœ… v2.7.1_SUMMARY.md
- âœ… v2.8.0_SUMMARY.md

---

**All features complete and ready for deployment! ðŸŽ‰**
